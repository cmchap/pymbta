<!DOCTYPE html>
<html lang="en" ng-app='MBTAApp'>
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
		<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.10/angular.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.10/angular-cookies.min.js"></script>
		<script>
			var MBTAApp = angular.module('MBTAApp',['ngCookies']);
			MBTAApp.controller('MBTACtrl', function ($scope, $cookieStore, $sce) {
				$scope.trains = $cookieStore.get('trains') || {};
				$scope.hidden = true;
				$scope.updated = $cookieStore.get('updated') || null;
				$scope.stop = $cookieStore.get('stop') || {};

				$scope.args = {};
				$scope.args.offset = $cookieStore.get('offset') || 0;
				$scope.args.direction = $cookieStore.get('direction') || null;
				$scope.args.line = $cookieStore.get('line') || null;

				$scope.go = function () {
					navigator.geolocation.getCurrentPosition(function (position) {
						args = {lat: position.coords.latitude, lon: position.coords.longitude};
						angular.extend(args, $scope.args);
						args.dt = Math.round(new Date() / 1000) + 60*60*args.offset;
						$.each($scope.args, function (k, v) {
							$cookieStore.put(k, v);
						});
						showPosition(args);
						getStop(args);
					});
				}
				$scope.getName = function (stop) {
					return stop.parent_station_name ? stop.parent_station_name : stop.stop_name;
				}
				$scope.getDistance = function (stop) {
					kilometers = (stop.distance*1.60934);
					if (kilometers > 1){
						return kilometers.toFixed(2);
					}
					else {
						return (kilometers*1000).toFixed();
					}
				}
				$scope.getArrivalTime = function (train) {
					return new moment(train.sch_arr_dt*1000).format('h:mm A');
				}
				$scope.tripDetails = function(train) {
				    return trust(train.trip_name.split(' - ').slice(0,-1).join('<br>'));
				}
				$scope.getColor = function(trains) {
				    return trains.route_name.split(' ')[0].toLowerCase();
				}
				function trust(html) {
				    return $sce.trustAsHtml(html);
				}
				function showPosition(args) {
				    $.post( "/api/next_trains", args, function( data ) {
					  $scope.trains = data;
					  $scope.updated = moment().format('h:mm A');
					  $cookieStore.put('updated', $scope.updated);
					  $cookieStore.put('trains', data);
					  $scope.$apply();
					});
				}
				function getStop(args) {
				    $.post( "/api/nearby_stop", args, function( data ) {
					  $scope.stop = data;
					  $cookieStore.put('stop', data);
					  $scope.$apply();
					});
				}
				$scope.go();
			});
		</script>
	</head>
	<body ng-controller='MBTACtrl' style='text-align: center;'>
	    <div class="container">
	    	<h1>Nearby T Info</h1>
	    	<div>
	    		<form role="form">
	    			<div ng-show='!hidden'>
		    			<div class="form-group">
							<label>Offset (Hours)</label>
							<input class="form-control" type="number" ng-model='args.offset'>
						</div>
						<div class="form-group">
							<label>Direction</label>
							<input class="form-control" type="text" ng-model='args.direction'>
						</div>
						<div class="form-group">
							<label>Line</label>
							<input class="form-control" type="text" ng-model='args.line'>
						</div>
					</div>
					<div class="form-group">
						<button type='button' ng-click='hidden = !hidden' ng-show='hidden' class='btn btn-default' style='width:100%'>Advanced Search</button>
					</div>
					<div class="form-group">
						<button type='button' ng-click='go()' class='btn btn-default' style='width:100%'>Go!</button>
					</div>
				</form>
			</div>
			<hr>
			<h2>Nearest Stop</h2>
			<div ng-show='stop.distance'>
				<p>
					{{getName(stop)}}
					<br>
					<span ng-switch='(stop.distance*1.60934) > 1'>
						<span ng-switch-when='true'>
							({{ getDistance(stop) }} kilometers away)
						</span>
						<span ng-switch-when='false'>
							({{ getDistance(stop) }} meters away)
						</span>
					</span>
				</p>
				<p>
					<a type='button' target='_blank' href="http://maps.google.com/?q={{getName(stop)}}" class='btn btn-default'>Map!</a>
				</p>
			</div>
			<div ng-show='!stop.distance'>
				<p>No nearby T stops.</p>
			</div>
			<hr>
			<h2>
				Next
				<ng-pluralize count='trains.trains.length' when="{'1': 'Train', 'other': 'Trains'}"></ng-pluralize>
			</h2>
			<div ng-show='trains.trains'>
				<h4>
					{{trains.trains.length}} {{trains.route_name}}
					<ng-pluralize count='trains.trains.length' when="{'1': 'Train', 'other': 'Trains'}"></ng-pluralize>
				</h4>
				<div ng-repeat='train in trains.trains' style='border-style: dotted; border-color: {{getColor(trains)}}'>
					<p>
						{{train.direction_name}}
						<br>
						{{getArrivalTime(train)}}
						<br>
						<small ng-bind-html="tripDetails(train)"></small>
					</p>
				</div>
			</div>
			<div ng-show='!trains.trains'>
				<p>No upcoming trains.</p>
			</div>
			<hr>
			<footer>
				<p ng-show='updated'>Last updated at {{updated}}</p>
			</footer>
	    </div><!-- /.container -->
	</body>
</html>